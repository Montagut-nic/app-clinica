import{a as ie}from"./chunk-P4HMIFTW.js";import{a as ye,b as be}from"./chunk-KXMOE7PO.js";import{a as ne}from"./chunk-GA5BIDOY.js";import{a as oe,b as se,c as le,d as ce,e as de,f as pe,g as me,h as ue,i as ge,j as fe,k as he,l as _e}from"./chunk-XUUOKOEX.js";import{a as ae}from"./chunk-J3JJFWGS.js";import{a as re}from"./chunk-JFWMHDSN.js";import{b as ee,c as te}from"./chunk-ZZF4ZVIA.js";import{b as J,c as Q,e as X,j as Z,k as $}from"./chunk-6ENO3YRF.js";import{$a as H,Aa as U,Ab as Y,Ba as d,Cb as S,Db as x,Eb as M,Lb as G,Pa as j,Ua as _,_ as I,ab as K,da as m,ea as u,eb as p,fb as n,g as N,gb as r,hb as E,la as L,lb as R,mb as V,nb as k,qb as w,rb as y,vb as b,wb as C,yb as c,zb as z}from"./chunk-TOHV62XN.js";function Se(s,i){s&1&&(n(0,"a",9),c(1," Volver a Administrar Usuarios "),r())}function xe(s,i){s&1&&(n(0,"a",10),c(1," Volver al inicio "),r())}function Me(s,i){s&1&&(R(0),c(1," Edad es requerida. "),V())}function Ie(s,i){s&1&&(R(0),c(1," Edad debe ser mayor a 0. "),V())}function Re(s,i){s&1&&(R(0),c(1," Correo Electr\xF3nico es requerido. "),V())}function Ve(s,i){s&1&&(R(0),c(1," Ingresa un correo electr\xF3nico v\xE1lido. "),V())}function Ne(s,i){s&1&&(R(0),c(1," Contrase\xF1a es requerida. "),V())}function Pe(s,i){s&1&&(R(0),c(1," La contrase\xF1a debe tener al menos 6 caracteres. "),V())}function ke(s,i){if(s&1&&(n(0,"span"),c(1),r()),s&2){let t=y();d(),Y(" ",t.selectedSpecialtiesLabels().join(", ")," ")}}function Oe(s,i){s&1&&(n(0,"span",45),c(1," Seleccion\xE1 una o varias especialidades. "),r())}function Te(s,i){if(s&1){let t=k();n(0,"div",53)(1,"label",54)(2,"input",55),w("change",function(a){let o=m(t).$implicit,l=y(2);return u(l.toggleSpecialty(o.id,a.target.checked))}),r(),n(3,"span"),c(4),r()()()}if(s&2){let t=i.$implicit,e=y(2);d(2),p("checked",e.isSpecialtySelected(t.id)),d(2),z(t.nombre)}}function Le(s,i){if(s&1){let t=k();n(0,"div",46),_(1,Te,5,2,"div",47),n(2,"div",48)(3,"div",49)(4,"input",50),M("ngModelChange",function(a){m(t);let o=y();return x(o.specialtyOtherInput,a)||(o.specialtyOtherInput=a),u(a)}),r(),n(5,"button",51),w("click",function(){m(t);let a=y();return u(a.addSpecialty())}),E(6,"i",52),c(7," Agregar "),r()(),n(8,"div",40),c(9," Las especialidades nuevas se usan solo para este registro. "),r()()()}if(s&2){let t=y();d(),p("ngForOf",t.specialties()),d(3),p("placeholder","Agregar nueva especialidad"),S("ngModel",t.specialtyOtherInput)}}function De(s,i){if(s&1){let t=k();n(0,"div",56)(1,"label",19),c(2," Captcha "),r(),n(3,"app-recaptcha",57),w("resolved",function(a){m(t);let o=y();return u(o.onCaptchaResolved(a))}),r(),n(4,"div",58),c(5,' Marc\xE1 la casilla "No soy un robot". '),r()()}if(s&2){let t=y();d(3),p("siteKey",t.siteKey)}}function We(s,i){s&1&&E(0,"span",59)}var ve=class s{specialties=L([]);selectedSpecialtyIds=[];specialtyDropdownOpen=!1;specialtyOtherInput="";siteKey=ee;captchaToken=null;captchaEnabled=L(!0);loader=I(re);router=I(Z);sb=I(te).client;authSvc=I(ne);specialtySvc=I(ie);toast=I(ae);isAdmin=L(!1);nombre="";apellido="";edad=null;dni="";email="";password="";loading;fotoEsp;onFileChange(i){let e=i.target.files?.[0]||void 0;this.fotoEsp=e}ngOnInit(){return N(this,null,function*(){let{data:i,error:t}=yield this.sb.rpc("get-captcha-enabled");this.captchaEnabled.set(i===!0&&!t),this.cargarEspecialidades(),document.title="La Cl\xEDnica Online - Registro de Especialista",(yield this.authSvc.isAdmin())&&(this.captchaEnabled.set(!1),this.isAdmin.set(!0))})}cargarEspecialidades(){return N(this,null,function*(){try{let{data:i,error:t}=yield this.specialtySvc.listActive();t||this.specialties.set((i??[]).map(e=>({id:e.id,nombre:e.nombre})))}catch{}})}onCaptchaResolved(i){this.captchaToken=i}toggleSpecialtyDropdown(){this.specialtyDropdownOpen=!this.specialtyDropdownOpen}isSpecialtySelected(i){return this.selectedSpecialtyIds.includes(i)}toggleSpecialty(i,t){t?this.selectedSpecialtyIds.includes(i)||this.selectedSpecialtyIds.push(i):this.selectedSpecialtyIds=this.selectedSpecialtyIds.filter(e=>e!==i)}selectedSpecialtiesLabels(){let i=new Map(this.specialties().map(t=>[t.id,t.nombre]));return this.selectedSpecialtyIds.map(t=>i.get(t)).filter(t=>!!t)}addSpecialty(){let i=this.specialtyOtherInput.trim();if(!i||i===""){this.toast.error("El nombre de la especialidad no puede estar vac\xEDo.");return}let t=this.specialties(),e=t.find(o=>o.nombre.toLowerCase()===i.toLowerCase()),a;e?a=e.id:(a=`${Date.now()}`,this.specialties.set([...t,{id:a,nombre:i,isCustom:!0}])),this.selectedSpecialtyIds.includes(a)||this.selectedSpecialtyIds.push(a),this.specialtyOtherInput="",this.toast.success("Especialidad agregada exitosamente.")}onDocumentClick(i){let t=i.target;if(!t)return;t.closest(".specialty-multiselect")||(this.specialtyDropdownOpen=!1)}validar(){return this.nombre.trim()?this.apellido.trim()?!this.edad||this.edad<=0?"La edad no es v\xE1lida.":/^\d{6,9}$/.test(this.dni)?/^\S+@\S+\.\S+$/.test(this.email)?(this.password??"").length<6?"La contrase\xF1a debe tener al menos 6 caracteres.":this.selectedSpecialtyIds.length===0?"Eleg\xED al menos una especialidad":this.fotoEsp?null:"La foto del especialista es obligatoria.":"El correo electr\xF3nico no es v\xE1lido.":"El DNI no es v\xE1lido.":"El apellido es obligatorio.":"El nombre es obligatorio."}submit(){return N(this,null,function*(){let i=this.validar();if(i){this.toast.error(i);return}if(this.captchaEnabled()){if(!this.captchaToken){this.toast.error("Complet\xE1 el captcha.");return}let{data:o,error:l}=yield this.sb.functions.invoke("verify-recaptcha",{body:{token:this.captchaToken}});if(l||!o?.success){this.toast.error("Captcha inv\xE1lido. Intent\xE1 nuevamente.");return}}let t=[],e=null;t=this.specialties().filter(o=>!o.isCustom&&this.selectedSpecialtyIds.includes(o.id)).map(o=>o.id);let a=this.specialties().filter(o=>o.isCustom&&this.selectedSpecialtyIds.includes(o.id)).map(o=>o.nombre);e=a.length>0?a.join(", "):null,this.loader.show();try{let o=this.sb.storage.from("avatars"),l=`${this.dni.trim()}-${Date.now()}`,{data:f,error:P}=yield this.sb.rpc("dni_exists",{_doc:this.dni.trim()});if(P){console.warn("[register] dni_exists error:",P),this.toast.error("No se pudo validar el DNI. Intentalo nuevamente.");return}if(f){console.warn("[register] dni_exists:",f),this.toast.error("Ya existe un usuario con ese DNI.");return}let{data:v,error:h}=yield this.sb.rpc("email_exists",{_correo:this.email.trim().toLowerCase()});if(h){console.warn("[register] email_exists error:",h),this.toast.error("No se pudo validar el correo electr\xF3nico. Intentalo nuevamente.");return}if(v){this.toast.error("Ya existe un usuario con ese correo electr\xF3nico.");return}let D=(g,T)=>N(this,null,function*(){if(!g)return null;let Ce=(g.name.split(".").pop()||"jpg").toLowerCase(),A=`${l}/${T}-${Date.now()}.${Ce}`,{error:B}=yield o.upload(A,g,{upsert:!0});if(B)throw B;return A}),W=null;try{W=yield D(this.fotoEsp,"especialista")}catch(g){console.warn("[register] upload pending error:",g?.message||g)}let{data:Ee,error:F}=yield this.sb.auth.signUp({email:this.email.trim().toLowerCase(),password:this.password,options:{data:{rol:"especialista",nombre:this.nombre.trim(),apellido:this.apellido.trim(),edad:this.edad,dni:this.dni.trim(),obra_social:null,avatar_path1:W,avatar_path2:null,specialties_ids:t,specialty_other:e}}});if(F){this.toast.error(F.message);return}let O=Ee.user;if(!O){this.toast.error("No se pudo crear el usuario.");return}let we=t.join(", "),{error:q}=yield this.sb.rpc("insert_pending_profile",{_email:this.email.trim().toLowerCase(),_nombre:this.nombre.trim(),_apellido:this.apellido.trim(),_edad:this.edad,_dni:this.dni.trim(),_specialty_id:we,_specialty_other:e,_avatar_path1:W,_uuid:O.id});if(q){console.warn("[register] rpc insert_pending_profile error:",q),this.toast.error("No se pudo preparar el registro.");return}this.specialties().forEach(g=>N(this,null,function*(){if(this.selectedSpecialtyIds.includes(g.id))if(g.isCustom){let{data:T}=yield this.specialtySvc.addCustom(g.nombre);T&&(yield this.sb.from("profile_specialty").insert({profile_id:O.id,specialty_id:T.id}))}else yield this.sb.from("profile_specialty").insert({profile_id:O.id,specialty_id:g.id})})),this.isAdmin()?(this.toast.success("Especialista registrado exitosamente. Un correo fue enviado para confirmar la cuenta."),this.router.navigateByUrl("/usuarios")):(this.toast.success("Un correo fue enviado para confirmar la cuenta. Confirm\xE1 tu cuenta y luego inici\xE1 sesi\xF3n para completar el perfil."),this.router.navigateByUrl("/acceso"))}finally{this.loader.hide()}})}static \u0275fac=function(t){return new(t||s)};static \u0275cmp=j({type:s,selectors:[["app-registro-especialista"]],hostBindings:function(t,e){t&1&&w("click",function(o){return e.onDocumentClick(o)},U)},decls:86,vars:35,consts:[["f","ngForm"],["nombreNg","ngModel"],["apellidoNg","ngModel"],["edadNg","ngModel"],["dniNg","ngModel"],["emailNg","ngModel"],["pwdNg","ngModel"],["specialtiesPlaceholder",""],[1,"container","py-4"],["routerLink","/usuarios","aria-label","Volver a la p\xE1gina de administrar usuarios",1,"volver-button"],["routerLink","/inicio","aria-label","Volver a la p\xE1gina de inicio",1,"volver-button"],[1,"card","shadow-sm"],[1,"card-header","bg-light","d-flex","align-items-center","gap-2"],[1,"bi","bi-person-plus"],[1,"mb-0"],[1,"card-body"],["novalidate",""],[1,"row","g-3"],[1,"col-md-6"],[1,"form-label"],["name","nombre","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"invalid-feedback"],["name","apellido","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-md-4"],["type","number","name","edad","min","1","required","",1,"form-control",3,"ngModelChange","ngModel"],[4,"ngIf"],["name","dni","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"my-4"],["type","email","name","email","required","","email","",1,"form-control",3,"ngModelChange","ngModel"],[1,"input-group"],["name","password","required","","minlength","6",1,"form-control",3,"ngModelChange","type","ngModel"],[1,"input-group-text"],[1,"bi","bi-shield-lock"],[1,"mt-4"],["type","file","accept","image/*",1,"form-control",3,"change"],[1,"specialty-multiselect"],["type","button",1,"specialty-multiselect-toggle",3,"click"],[4,"ngIf","ngIfElse"],[1,"bi","bi-chevron-down","ms-auto","small","text-muted"],["class","specialty-multiselect-dropdown",4,"ngIf"],[1,"form-text","mt-1"],["class","mb-3",4,"ngIf"],[1,"d-grid","mt-4"],["type","button",1,"btn","btn-primary","btn-lg",3,"captchaPassed","appCaptcha","persist"],["class","spinner-border spinner-border-sm me-2",4,"ngIf"],[1,"specialty-multiselect-placeholder"],[1,"specialty-multiselect-dropdown"],["class","specialty-option",4,"ngFor","ngForOf"],[1,"specialty-multiselect-footer"],[1,"input-group","input-group-sm"],["name","espNueva",1,"form-control",3,"ngModelChange","placeholder","ngModel"],["type","button",1,"btn","btn-outline-secondary",3,"click"],[1,"bi","bi-plus-lg","me-1"],[1,"specialty-option"],[1,"form-check-label"],["type","checkbox",1,"form-check-input","me-2",3,"change","checked"],[1,"mb-3"],[3,"resolved","siteKey"],[1,"form-text"],[1,"spinner-border","spinner-border-sm","me-2"]],template:function(t,e){if(t&1){let a=k();n(0,"div",8),H(1,Se,2,0,"a",9)(2,xe,2,0,"a",10),n(3,"div",11)(4,"div",12),E(5,"i",13),n(6,"h5",14),c(7," Registro Especialista "),r()(),n(8,"div",15)(9,"form",16,0)(11,"div",17)(12,"div",18)(13,"label",19),c(14," Nombre "),r(),n(15,"input",20,1),M("ngModelChange",function(l){return m(a),x(e.nombre,l)||(e.nombre=l),u(l)}),r(),n(17,"div",21),c(18," Nombre es requerido. "),r()(),n(19,"div",18)(20,"label",19),c(21," Apellido "),r(),n(22,"input",22,2),M("ngModelChange",function(l){return m(a),x(e.apellido,l)||(e.apellido=l),u(l)}),r(),n(24,"div",21),c(25," Apellido es requerido. "),r()(),n(26,"div",23)(27,"label",19),c(28," Edad "),r(),n(29,"input",24,3),M("ngModelChange",function(l){return m(a),x(e.edad,l)||(e.edad=l),u(l)}),r(),n(31,"div",21),_(32,Me,2,0,"ng-container",25)(33,Ie,2,0,"ng-container",25),r()(),n(34,"div",23)(35,"label",19),c(36," DNI "),r(),n(37,"input",26,4),M("ngModelChange",function(l){return m(a),x(e.dni,l)||(e.dni=l),u(l)}),r(),n(39,"div",21),c(40," DNI es requerido. "),r()()(),E(41,"hr",27),n(42,"div",17)(43,"div",18)(44,"label",19),c(45," Correo Electr\xF3nico "),r(),n(46,"input",28,5),M("ngModelChange",function(l){return m(a),x(e.email,l)||(e.email=l),u(l)}),r(),n(48,"div",21),_(49,Re,2,0,"ng-container",25)(50,Ve,2,0,"ng-container",25),r()(),n(51,"div",18)(52,"label",19),c(53," Contrase\xF1a "),r(),n(54,"div",29)(55,"input",30,6),M("ngModelChange",function(l){return m(a),x(e.password,l)||(e.password=l),u(l)}),r(),n(57,"span",31),E(58,"i",32),r(),n(59,"div",21),_(60,Ne,2,0,"ng-container",25)(61,Pe,2,0,"ng-container",25),r()()()(),n(62,"div",33)(63,"div",17)(64,"div",18)(65,"label",19),c(66," Foto de perfil "),r(),n(67,"input",34),w("change",function(l){return m(a),u(e.onFileChange(l))}),r()(),n(68,"div",18)(69,"label",19),c(70," Especialidades "),r(),n(71,"div",35)(72,"button",36),w("click",function(){return m(a),u(e.toggleSpecialtyDropdown())}),_(73,ke,2,1,"span",37)(74,Oe,2,0,"ng-template",null,7,G),E(76,"i",38),r(),_(77,Le,10,3,"div",39),r(),n(78,"div",40),c(79," Pod\xE9s seleccionar una o varias especialidades marcando las casillas. "),r()()()(),E(80,"hr",27),_(81,De,6,1,"div",41),n(82,"div",42)(83,"button",43),w("captchaPassed",function(){return m(a),u(e.submit())}),_(84,We,1,0,"span",44),c(85," Crear cuenta "),r()()()()()()}if(t&2){let a=b(10),o=b(16),l=b(23),f=b(30),P=b(38),v=b(47),h=b(56),D=b(75);d(),K(e.isAdmin()?1:2),d(14),C("is-invalid",o.invalid&&(o.touched||a.submitted)),S("ngModel",e.nombre),d(7),C("is-invalid",l.invalid&&(l.touched||a.submitted)),S("ngModel",e.apellido),d(7),C("is-invalid",f.invalid&&(f.touched||a.submitted)),S("ngModel",e.edad),d(3),p("ngIf",f.errors==null?null:f.errors.required),d(),p("ngIf",f.errors==null?null:f.errors.min),d(4),C("is-invalid",P.invalid&&(P.touched||a.submitted)),S("ngModel",e.dni),d(9),C("is-invalid",v.invalid&&(v.touched||a.submitted)),S("ngModel",e.email),d(3),p("ngIf",v.errors==null?null:v.errors.required),d(),p("ngIf",v.errors==null?null:v.errors.email),d(5),C("is-invalid",h.invalid&&(h.touched||a.submitted)),p("type","password"),S("ngModel",e.password),d(5),p("ngIf",h.errors==null?null:h.errors.required),d(),p("ngIf",h.errors==null?null:h.errors.minlength),d(11),C("open",e.specialtyDropdownOpen),d(),p("ngIf",e.selectedSpecialtiesLabels().length)("ngIfElse",D),d(4),p("ngIf",e.specialtyDropdownOpen),d(4),p("ngIf",e.captchaEnabled),d(2),p("appCaptcha",e.captchaEnabled())("persist",!1),d(),p("ngIf",e.loading)}},dependencies:[X,J,Q,_e,pe,oe,me,se,le,ge,he,fe,ue,de,ce,ye,be,$],styles:[".card-header[_ngcontent-%COMP%]{font-weight:600}.input-group[_ngcontent-%COMP%] > .form-control[_ngcontent-%COMP%]:focus{box-shadow:none}.form-text[_ngcontent-%COMP%]{opacity:.85}.specialty-multiselect[_ngcontent-%COMP%]{position:relative}.specialty-multiselect-toggle[_ngcontent-%COMP%]{width:100%;display:flex;align-items:center;gap:.5rem;border-radius:.375rem;border:1px solid var(--bs-border-color);background-color:#fff;padding:.375rem .75rem;cursor:pointer;font-size:.95rem}.specialty-multiselect-toggle.open[_ngcontent-%COMP%], .specialty-multiselect-toggle[_ngcontent-%COMP%]:focus{outline:0;border-color:#0d6efd;box-shadow:0 0 0 .15rem #0d6efd40}.specialty-multiselect-placeholder[_ngcontent-%COMP%]{color:#6c757d}.specialty-multiselect-dropdown[_ngcontent-%COMP%]{position:absolute;top:100%;left:0;width:100%;margin-top:.25rem;background-color:#fff;border-radius:.5rem;border:1px solid var(--bs-border-color);box-shadow:0 10px 30px #0f172a26;max-height:260px;overflow-y:auto;z-index:1050}.specialty-option[_ngcontent-%COMP%]{padding:.25rem .75rem}.specialty-option[_ngcontent-%COMP%]:hover{background-color:#f3f4f6}.specialty-option[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{width:100%;display:flex;align-items:center;cursor:pointer}.specialty-multiselect-footer[_ngcontent-%COMP%]{border-top:1px solid #e5e7eb;padding:.5rem .75rem .6rem;background-color:#f9fafb}.volver-button[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;padding:.6rem 1.4rem;border-radius:999px;border:none;text-decoration:none;font-weight:600;font-size:.95rem;background:linear-gradient(135deg,var(--blue-green),var(--bright-blue));color:#fff;width:fit-content;margin-bottom:4%;box-shadow:0 8px 20px #00000059,0 0 0 1px #ffffff4d;transition:transform .12s ease,box-shadow .12s ease,filter .12s ease}"]})};export{ve as RegistroEspecialista};
