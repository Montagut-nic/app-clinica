import{a as ce,b as me}from"./chunk-KXMOE7PO.js";import{a as J}from"./chunk-GA5BIDOY.js";import{a as Z,b as $,c as ee,d as te,e as ie,f as ne,g as re,h as ae,i as oe,j as le,k as se,l as de}from"./chunk-XUUOKOEX.js";import{a as X}from"./chunk-J3JJFWGS.js";import{a as Q}from"./chunk-JFWMHDSN.js";import{b as G,c as H}from"./chunk-ZZF4ZVIA.js";import{c as K,e as j,j as Y,k as z}from"./chunk-6ENO3YRF.js";import{$a as B,Ba as s,Cb as v,Db as w,Eb as y,Pa as O,Ua as x,_ as M,ab as U,da as m,ea as p,eb as u,fb as e,g as L,gb as t,hb as N,la as W,lb as C,mb as E,nb as q,qb as R,rb as k,vb as g,wb as h,yb as r}from"./chunk-TOHV62XN.js";function fe(o,l){o&1&&(e(0,"a",11),r(1," Volver a Administrar Usuarios "),t())}function he(o,l){o&1&&(e(0,"a",12),r(1," Volver al inicio "),t())}function _e(o,l){o&1&&(C(0),r(1," Edad es requerida. "),E())}function be(o,l){o&1&&(C(0),r(1," Edad debe ser mayor a 0. "),E())}function ve(o,l){o&1&&(C(0),r(1," Correo electr\xF3nico es requerido. "),E())}function we(o,l){o&1&&(C(0),r(1," Ingresa un correo electr\xF3nico v\xE1lido. "),E())}function ye(o,l){o&1&&(C(0),r(1," Contrase\xF1a es requerida. "),E())}function Ce(o,l){o&1&&(C(0),r(1," La contrase\xF1a debe tener al menos 6 caracteres. "),E())}function Ee(o,l){if(o&1){let c=q();e(0,"div",44)(1,"label",21),r(2," Captcha "),t(),e(3,"app-recaptcha",45),R("resolved",function(a){m(c);let d=k();return p(d.onCaptchaResolved(a))}),t(),e(4,"div",39),r(5,' Marc\xE1 la casilla "No soy un robot". '),t()()}if(o&2){let c=k();s(3),u("siteKey",c.siteKey)}}function Se(o,l){o&1&&N(0,"span",46)}var pe=class o{captchaToken=null;captchaEnabled=W(!0);siteKey=G;loader=M(Q);router=M(Y);sb=M(H).client;authSvc=M(J);toast=M(X);isAdmin=W(!1);nombre="";apellido="";edad=null;dni="";obra_social="";email="";password="";loading;foto1;foto2;ngOnInit(){return L(this,null,function*(){let{data:l,error:c}=yield this.sb.rpc("get-captcha-enabled");this.captchaEnabled.set(l===!0&&!c),document.title="La Cl\xEDnica Online - Registro de Paciente",(yield this.authSvc.isAdmin())&&(this.captchaEnabled.set(!1),this.isAdmin.set(!0))})}onCaptchaResolved(l){this.captchaToken=l}onFileChange(l,c){let a=c.target.files?.[0]||void 0;l==="p1"&&(this.foto1=a),l==="p2"&&(this.foto2=a)}validar(){return this.nombre.trim()?this.apellido.trim()?!this.edad||this.edad<=0?"La edad no es v\xE1lida.":/^\d{6,9}$/.test(this.dni)?/^\S+@\S+\.\S+$/.test(this.email)?(this.password??"").length<6?"La contrase\xF1a debe tener al menos 6 caracteres.":this.obra_social.trim()?this.foto1?this.foto2?null:"La imagen de perfil secundaria es obligatoria.":"La imagen de perfil es obligatoria.":"La obra social es obligatoria.":"El correo electr\xF3nico no es v\xE1lido.":"El DNI no es v\xE1lido.":"El apellido es obligatorio.":"El nombre es obligatorio."}submit(){return L(this,null,function*(){let l=this.validar();if(l){this.toast.error(l);return}if(this.captchaEnabled()){if(!this.captchaToken){this.toast.error("Complet\xE1 el captcha.");return}let{data:c,error:n}=yield this.sb.functions.invoke("verify-recaptcha",{body:{token:this.captchaToken}});if(n||!c?.success){this.toast.error("Captcha inv\xE1lido. Intent\xE1 nuevamente.");return}}this.loader.show();try{let c=this.sb.storage.from("avatars"),n=`${this.dni.trim()}-${Date.now()}`,{data:a,error:d}=yield this.sb.rpc("dni_exists",{_doc:this.dni.trim()});if(d){console.warn("[register] dni_exists error:",d),this.toast.error("No se pudo validar el DNI. Intentalo nuevamente.");return}if(a){console.warn("[register] dni_exists:",a),this.toast.error("Ya existe un usuario con ese DNI.");return}let{data:i,error:_}=yield this.sb.rpc("email_exists",{_correo:this.email.trim().toLowerCase()});if(_){console.warn("[register] email_exists error:",_),this.toast.error("No se pudo validar el correo electr\xF3nico. Intentalo nuevamente.");return}if(i){this.toast.error("Ya existe un usuario con ese correo electr\xF3nico.");return}let V=(P,ue)=>L(this,null,function*(){if(!P)return null;let ge=(P.name.split(".").pop()||"jpg").toLowerCase(),D=`${n}/${ue}-${Date.now()}.${ge}`,{error:A}=yield c.upload(D,P,{upsert:!0});if(A)throw A;return D}),S=null,f=null;try{S=yield V(this.foto1,"paciente-1"),f=yield V(this.foto2,"paciente-2")}catch(P){console.warn("[register] upload pending error:",P?.message||P)}let{data:b,error:I}=yield this.sb.auth.signUp({email:this.email.trim().toLowerCase(),password:this.password,options:{data:{rol:"paciente",nombre:this.nombre.trim(),apellido:this.apellido.trim(),edad:this.edad,dni:this.dni.trim(),obra_social:this.obra_social.trim(),avatar_path1:S,avatar_path2:f,specialties_ids:null,specialty_other:null}}});if(I){this.toast.error(I.message);return}let T=b.user;if(!T){this.toast.error("No se pudo crear el usuario.");return}let{error:F}=yield this.sb.rpc("insert_patient_profile",{_email:this.email.trim().toLowerCase(),_nombre:this.nombre.trim(),_apellido:this.apellido.trim(),_edad:this.edad,_dni:this.dni.trim(),_obra_social:this.obra_social.trim(),_avatar_path1:S,_avatar_path2:f,_uuid:T.id});if(F){console.warn("[register] rpc insert_patient_profile error:",F),this.toast.error("No se pudo preparar el registro.");return}this.isAdmin()?(this.toast.success("Paciente registrado exitosamente. Un correo fue enviado para confirmar la cuenta."),this.router.navigateByUrl("/usuarios")):(this.toast.success("Un correo fue enviado para confirmar la cuenta. Confirm\xE1 tu cuenta y luego inici\xE1 sesi\xF3n para completar el perfil."),this.router.navigateByUrl("/acceso"))}finally{this.loader.hide()}})}static \u0275fac=function(c){return new(c||o)};static \u0275cmp=O({type:o,selectors:[["app-registro-paciente"]],decls:93,vars:37,consts:[["f","ngForm"],["nombreNg","ngModel"],["apellidoNg","ngModel"],["edadNg","ngModel"],["dniNg","ngModel"],["obraNg","ngModel"],["emailNg","ngModel"],["pwdNg","ngModel"],["fileP1",""],["fileP2",""],[1,"container","py-4"],["routerLink","/usuarios","aria-label","Volver a la p\xE1gina de administrar usuarios",1,"volver-button"],["routerLink","/inicio","aria-label","Volver a la p\xE1gina de inicio",1,"volver-button"],[1,"card","shadow-sm"],[1,"card-header","bg-light","d-flex","align-items-center","gap-2"],[1,"bi","bi-person-plus"],[1,"mb-0"],[1,"card-body"],["novalidate",""],[1,"row","g-3"],[1,"col-md-6"],[1,"form-label"],["name","nombre","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"invalid-feedback"],["name","apellido","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-md-4"],["type","number","name","edad","min","1","required","",1,"form-control",3,"ngModelChange","ngModel"],[4,"ngIf"],["name","dni","required","",1,"form-control",3,"ngModelChange","ngModel"],["name","obra","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"my-4"],["type","email","name","email","required","","email","",1,"form-control",3,"ngModelChange","ngModel"],[1,"input-group"],["name","password","required","","minlength","6",1,"form-control",3,"ngModelChange","type","ngModel"],[1,"input-group-text"],[1,"bi","bi-shield-lock"],[1,"mt-4"],[1,"form-label","fw-semibold"],["type","file","accept","image/*",1,"form-control",3,"change"],[1,"form-text"],["class","mb-3",4,"ngIf"],[1,"d-grid","mt-4"],["type","button",1,"btn","btn-primary","btn-lg",3,"captchaPassed","appCaptcha","persist"],["class","spinner-border spinner-border-sm me-2",4,"ngIf"],[1,"mb-3"],[3,"resolved","siteKey"],[1,"spinner-border","spinner-border-sm","me-2"]],template:function(c,n){if(c&1){let a=q();e(0,"div",10),B(1,fe,2,0,"a",11)(2,he,2,0,"a",12),e(3,"div",13)(4,"div",14),N(5,"i",15),e(6,"h5",16),r(7," Registro Paciente "),t()(),e(8,"div",17)(9,"form",18,0)(11,"div",19)(12,"div",20)(13,"label",21),r(14," Nombre "),t(),e(15,"input",22,1),y("ngModelChange",function(i){return m(a),w(n.nombre,i)||(n.nombre=i),p(i)}),t(),e(17,"div",23),r(18," Nombre es requerido. "),t()(),e(19,"div",20)(20,"label",21),r(21," Apellido "),t(),e(22,"input",24,2),y("ngModelChange",function(i){return m(a),w(n.apellido,i)||(n.apellido=i),p(i)}),t(),e(24,"div",23),r(25," Apellido es requerido. "),t()(),e(26,"div",25)(27,"label",21),r(28," Edad "),t(),e(29,"input",26,3),y("ngModelChange",function(i){return m(a),w(n.edad,i)||(n.edad=i),p(i)}),t(),e(31,"div",23),x(32,_e,2,0,"ng-container",27)(33,be,2,0,"ng-container",27),t()(),e(34,"div",25)(35,"label",21),r(36," DNI "),t(),e(37,"input",28,4),y("ngModelChange",function(i){return m(a),w(n.dni,i)||(n.dni=i),p(i)}),t(),e(39,"div",23),r(40," DNI es requerido. "),t()(),e(41,"div",25)(42,"label",21),r(43," Obra Social "),t(),e(44,"input",29,5),y("ngModelChange",function(i){return m(a),w(n.obra_social,i)||(n.obra_social=i),p(i)}),t(),e(46,"div",23),r(47," Obra Social es requerida. "),t()()(),N(48,"hr",30),e(49,"div",19)(50,"div",20)(51,"label",21),r(52," Correo Electr\xF3nico "),t(),e(53,"input",31,6),y("ngModelChange",function(i){return m(a),w(n.email,i)||(n.email=i),p(i)}),t(),e(55,"div",23),x(56,ve,2,0,"ng-container",27)(57,we,2,0,"ng-container",27),t()(),e(58,"div",20)(59,"label",21),r(60," Contrase\xF1a "),t(),e(61,"div",32)(62,"input",33,7),y("ngModelChange",function(i){return m(a),w(n.password,i)||(n.password=i),p(i)}),t(),e(64,"span",34),N(65,"i",35),t(),e(66,"div",23),x(67,ye,2,0,"ng-container",27)(68,Ce,2,0,"ng-container",27),t()()()(),e(69,"div",36)(70,"label",37),r(71," Im\xE1genes de perfil (obligatorio) "),t(),e(72,"div",19)(73,"div",20)(74,"input",38,8),R("change",function(i){return m(a),p(n.onFileChange("p1",i))}),t(),e(76,"div",39),r(77," Principal "),t(),e(78,"div",23),r(79," Imagen de perfil principal es requerida. "),t()(),e(80,"div",20)(81,"input",38,9),R("change",function(i){return m(a),p(n.onFileChange("p2",i))}),t(),e(83,"div",39),r(84," Secundaria "),t(),e(85,"div",23),r(86," Imagen de perfil secundaria es requerida. "),t()()()(),N(87,"hr",30),x(88,Ee,6,1,"div",40),e(89,"div",41)(90,"button",42),R("captchaPassed",function(){return m(a),p(n.submit())}),x(91,Se,1,0,"span",43),r(92," Crear cuenta "),t()()()()()()}if(c&2){let a=g(10),d=g(16),i=g(23),_=g(30),V=g(38),S=g(45),f=g(54),b=g(63),I=g(75),T=g(82);s(),U(n.isAdmin()?1:2),s(14),h("is-invalid",d.invalid&&(d.touched||a.submitted)),v("ngModel",n.nombre),s(7),h("is-invalid",i.invalid&&(i.touched||a.submitted)),v("ngModel",n.apellido),s(7),h("is-invalid",_.invalid&&(_.touched||a.submitted)),v("ngModel",n.edad),s(3),u("ngIf",_.errors==null?null:_.errors.required),s(),u("ngIf",_.errors==null?null:_.errors.min),s(4),h("is-invalid",V.invalid&&(V.touched||a.submitted)),v("ngModel",n.dni),s(7),h("is-invalid",S.invalid&&(S.touched||a.submitted)),v("ngModel",n.obra_social),s(9),h("is-invalid",f.invalid&&(f.touched||a.submitted)),v("ngModel",n.email),s(3),u("ngIf",f.errors==null?null:f.errors.required),s(),u("ngIf",f.errors==null?null:f.errors.email),s(5),h("is-invalid",b.invalid&&(b.touched||a.submitted)),u("type","password"),v("ngModel",n.password),s(5),u("ngIf",b.errors==null?null:b.errors.required),s(),u("ngIf",b.errors==null?null:b.errors.minlength),s(6),h("is-invalid",a.submitted&&!I.value),s(7),h("is-invalid",a.submitted&&!T.value),s(7),u("ngIf",n.captchaEnabled),s(2),u("appCaptcha",n.captchaEnabled())("persist",!1),s(),u("ngIf",n.loading)}},dependencies:[de,ne,Z,re,$,ee,oe,se,le,ae,ie,te,j,K,ce,me,z],styles:[".card-header[_ngcontent-%COMP%]{font-weight:600}.input-group[_ngcontent-%COMP%] > .form-control[_ngcontent-%COMP%]:focus{box-shadow:none}.volver-button[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;padding:.6rem 1.4rem;border-radius:999px;border:none;text-decoration:none;font-weight:600;font-size:.95rem;background:linear-gradient(135deg,var(--blue-green),var(--bright-blue));color:#fff;width:fit-content;margin-bottom:4%;box-shadow:0 8px 20px #00000059,0 0 0 1px #ffffff4d;transition:transform .12s ease,box-shadow .12s ease,filter .12s ease}"]})};export{pe as RegistroPaciente};
