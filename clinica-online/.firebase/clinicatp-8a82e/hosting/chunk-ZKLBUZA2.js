import{a as R}from"./chunk-P4HMIFTW.js";import{a as $}from"./chunk-GA5BIDOY.js";import{a as S,b as N,c as m}from"./chunk-UYNQNJ36.js";import{c as P}from"./chunk-ZZF4ZVIA.js";import{Ha as b,Qb as w,V as v,_ as a,g as t,la as _,n as g}from"./chunk-TOHV62XN.js";var D=class p{sb=a(P).client;specialtySvc=a(R);_user$=new g(null);_profile=_(null);_loading=_(!1);_ready=_(!1);auth=a($);_initPromise=null;_whenProfileReadyResolvers=[];profile=this._profile.asReadonly();loading=this._loading.asReadonly();ready=this._ready.asReadonly();isLoggedIn=w(()=>!!this.user$);_ngZone=a(b);hydrate(){return t(this,null,function*(){return this._initPromise?this._initPromise:(this._initPromise=t(this,null,function*(){let{data:{session:i}}=yield this.sb.auth.getSession();this._user$.next(i?.user??null),this.user?yield this.loadProfile():this._profile.set(null),this.sb.auth.onAuthStateChange((e,n)=>{this._ngZone.run(()=>{this._user$.next(n?.user??null),this.user?this.loadProfile():this._profile.set(null)})}),this._ready.set(!0)}),this._initPromise)})}waitReady(){return t(this,null,function*(){yield this.hydrate()})}get user$(){return this._user$.asObservable()}get user(){return this._user$.value}waitForProfile(){return t(this,null,function*(){if(this.loading())return new Promise(i=>{this._whenProfileReadyResolvers.push(i)})})}refresh(){return t(this,null,function*(){yield this.loadProfile()})}logout(){return t(this,null,function*(){try{let{error:i}=yield this.sb.auth.signOut();i&&console.error("[session] logout error:",i)}catch(i){console.error("[session] logout exception:",i)}finally{this._user$.next(null),this._profile.set(null),this._ready.set(!0)}})}loadProfile(){return t(this,null,function*(){this._loading.set(!0);try{let i=this.user;if(!i){this._profile.set(null);return}let{data:e,error:n}=yield this.sb.from("profiles").select("*").eq("_uuid",i.id).maybeSingle();if(n&&console.warn("[session] select profile error:",n.message),e){let l;if(e._rol==="admin")l=new S(e._nombre,e._apellido,Number(e._edad),e._dni,e._email,e._uuid,e._avatar_path1);else if(e._rol==="especialista"){let u=i.user_metadata.specialties_ids,c=i.user_metadata.specialty_other,f=[];if(Array.isArray(u)&&u.length>0&&typeof u[0]=="string"&&u.forEach(d=>t(this,null,function*(){let{data:s,error:o}=yield this.specialtySvc.getById(d);o?console.warn("[session] fetch specialty error:",o.message):s?f.push({id:s.id,nombre:s.nombre}):console.warn("[session] specialty not found for id:",d)})),c&&typeof c=="string"){let d=c.split(",").map(s=>s.trim()).filter(s=>s.length>0);for(let s of d){let{data:o,error:y}=yield this.specialtySvc.getByName(s);y?console.warn("[session] fetch specialty error:",y.message):o?f.push({id:o.id,nombre:o.nombre}):console.warn("[session] specialty not found for id:",s)}}l=new N(e._nombre,e._apellido,Number(e._edad),e._dni,e._email,e._uuid,e._avatar_path1,f,!!e._is_approved)}else if(e._rol==="paciente")l=new m(e._nombre,e._apellido,Number(e._edad),e._dni,e._obra_social,e._email,e._uuid,e._avatar_path1,e._avatar_path2);else{console.warn(`Rol de usuario desconocido: ${e._rol}`),this._profile.set(null);return}this._profile.set(l);return}let{error:h}=yield this.sb.from("profiles").upsert({_uuid:i.id,_rol:"paciente",_nombre:"",_apellido:"",_edad:0,_dni:"PEND",_email:i.email},{onConflict:"_uuid",ignoreDuplicates:!0});h&&console.warn("[session] upsert profile error:",h.message);let{data:r}=yield this.sb.from("profiles").select("*").eq("_uuid",i.id).maybeSingle(),U=new m(r?._nombre||"",r?._apellido||"",Number(r?._edad)||0,r?._dni||"PEND",r?._obra_social||"",r._email,r._uuid,r?._avatar_path1||"",r?._avatar_path2||"");this._profile.set(U??null)}finally{this._loading.set(!1);let i=this._whenProfileReadyResolvers.splice(0);for(let e of i)e()}})}static \u0275fac=function(e){return new(e||p)};static \u0275prov=v({token:p,factory:p.\u0275fac,providedIn:"root"})};export{D as a};
